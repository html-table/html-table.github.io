console.do=(...e)=>{};customElements.define("html-table",class extends HTMLElement{constructor(){super().attachShadow({mode:"open"}).innerHTML=document.getElementById(this.nodeName+"-STYLE").innerHTML+"<style id=show></style><style id=filter></style>";this._t=this.query("table");this._f=this.query("#filter");this._s=this.query("#show");this.columns={}}query(e,t=this.shadowRoot){return(t||this).querySelector(e)}connectedCallback(){let e=this;console.timers=new Proxy([{label:"start",time:0,duration:0}],{set(t,s,r){if(!e.hasAttribute("timers"))return!0;if("length"!=s){r=String(r);let e=t.slice(-1)[0],a=Number(performance.now().toFixed(0));t[s]={label:r,time:r.includes("*")?0:a,duration:a-e.time};r.includes("*")}return!0}});this.json1=[{naam:"Danny",age:52,gender:"Male"},{naam:"Marcel",age:49,gender:"Male"},{naam:"Diny",age:76,gender:"Female"},{naam:"Kees",age:77,gender:"Male"},{naam:"Cecile",age:59,gender:"Female"},{naam:"Natascha",age:48,gender:"Female"},{naam:"Finn",age:17,gender:"Male"},{naam:"Kiki",age:15,gender:"Female"}];this.json?this.load(this.json):setTimeout((async()=>{this.for=this.getAttribute("for");this.shadowRoot.append(...this.querySelectorAll("[shadowRoot]"));if(this.for){44==this.for.length&&(this.for=`https://spreadsheets.google.com/feeds/list/${this.for}/od6/public/values?alt=json`);this.loadJSON(this.for)}}))}async loadJSON(e){if(e.startsWith("http")){let t=await(await fetch(e)).json(),s=this.getAttribute("headerrow")||0,r=e.includes("google"),a=t;r&&(a=t.feed.entry);this.headers={};Array.isArray(a)||(a=[...Object.entries(a)].reduce(((e,[t,s])=>!Array.isArray(e)&&Array.isArray(s)?s:e),a));if(!Array.isArray(a))return;a=a.slice(s,9999).map((e=>{r&&Object.entries(e).map((([t,s],r)=>{if(r=t.split("gsx$")[1]){this.headers[r]?r=this.headers[r]:this.headers[r]=r;e[r]=s.$t}delete e[t]}));return e}));this.load(a)}else{let t=this.query("#"+e,document)||this.query("#"+e,this.getRootNode().host);if(t)try{this.load(JSON.parse(t.innerHTML))}catch(e){}document.addEventListener(e,(e=>{let t=e.detail.rows;this.load(t)}))}}get show(){this.getAttribute("show")}set show(e="*"){this.setAttribute("show",e);this._s.innerHTML=`tbody tr[data-article*="${e}"]{background:lightgreen}`}row(e){}TRtoggle(e,t){"number"==typeof t&&(t=this.row(t))}parseStr=(e,t={})=>new Function("v","return(("+Object.keys(t).join(",")+")=>`"+e+"`)(...Object.values(v))")(t);set source(e){}load(e,t=this.querySelector("#columns")){e.headers;t&&[...t.content.children].map((e=>this.columns[e.getAttribute("name")||e.localName]=e.innerHTML.split("\n").map((e=>e.trim())).join("")));if(e.length){(e=e.map((e=>({sel:(this.columns.sel||"")+"<input type='checkbox'>",...e})))).length>1&&new Set(Object.keys(e[0]),Object.keys(e[1])).size==Object.keys(e[0]).length&&e.unshift(Object.keys(e[0]));this.$table=e.reduceRight(((e,t,s,r,a=r.length-1,i=(this.getAttribute("pagesizes")||"5,10,20,30,40").split`,`.concat(a),o=this.getAttribute("pagesize")||Number(i[0]),l=3,n=(this.getAttribute("excludecolumns")||"").split(","),d=(this.getAttribute("includecolumns")||"").split(","),u=(e=>{let t=n.includes(e),s=d.includes(e);return"*"==n&&s||s||!t}),c=(e=>Object.entries(t).map(e)),h=((e,t,r,a=document.createElement(e))=>{t&&("string"==typeof t?a.setAttribute("data-value",a.innerHTML=t):a.append(t));if(r){a.setAttribute("data-colname",r);a.setAttribute("aria-rowindex",s);p.append(a)}return a}),p=h("tr"))=>{if(s){p.row=t;p.setAttribute("role","row");p.setAttribute("aria-roleindex",s);p.setAttribute("data-index",s);c((([r,i],o)=>{this.columns[r]&&(i=this.parseStr(this.columns[r],{rowindex:s,colname:r,value:i,colindex:o,total:a,...t}));if("string"!=typeof i)if(Array.isArray(i)){let e=document.createElement(this.localName);e.json=i;i=e}else i="number"==typeof i?Number(i):typeof i;let l=h(0==o?"th":"td",i,r);l.setAttribute("role","cell");l.setAttribute("data-isnumber",Number(i)==i);l.setAttribute("data-colnr",o);l.setAttribute("title",i);p.setAttribute("data-"+r,i);undefined;if(o){e.columns.get(r)||e.columns.set(r,new Map);e.columns.get(r).get(i)||e.columns.get(r).set(i,[]);e.columns.get(r).get(i).push(t)}}));p.toggle=(e=!p.querySelector("input").checked)=>{p.querySelector("input").checked=e;p.classList.toggle("selected",e)};p.onclick=e=>{"INPUT"!=e.target.nodeName&&p.toggle()};e.TRs.unshift(p)}else{let t;c((([r,a],i,o)=>{let l,n=h("div",a),d=h("style"),u=h("th",n,a),c=h("select",""),p=h("div"),b=e.columns.get(a);u.colname=a;u.id=this.id+"_"+a;u.append(d,p);u.header=n;e.THs.push(u);e.groupby.push(c);u.setAttribute("role","columnheader");u.setAttribute("aria-label",a);u.setAttribute("aria-colindex",i);u.update=(t=!1)=>{if(!b)return;let s,r=(e,t)=>{l=h("option",((e,t)=>`(${t}) `+e)(e,t.length));l.setAttribute("value",e);return l},i=e.selected.map((e=>e.row[a])),o=c.value||"*";c.replaceChildren(r("*",u.values),...[...b.entries()].map((([e,a])=>{s=r(e,a);t?s.setAttribute("inselection",i.includes(e)):s.removeAttribute("inselection");return s})).reduceRight(((e,t,s,r,a=((t,s=document.createElement("optgroup"))=>{s.setAttribute("label","¥Y"[t]+" ("+e[t].length+")");s.append(...e[t].sort(((e,t)=>e.value.localeCompare(t.value))));return e[t]=e[t].length?s:""}))=>{e["false"==t.getAttribute("inselection")?0:1].unshift(t);return s?e:[a(1),a(0)]}),[[],[]]));c.value=o;c.options[0].scrollIntoView()};if(b){u.values=[...b.values()].flatMap((e=>e)).map((e=>e[a]));u.update();u.setAttribute("data-isnumber",u.isNumber=u.values.every((e=>Number(e)==e)));c.classList.add("columnfilter");c.setAttribute("size",15);c.setAttribute("data-colname",a);u.append(c);c.onchange=()=>u.groupby(c.value)}i&&(t.next=u);t=u;u.setwidth=e=>u.style.width=e+"px";p.style="top:0;right:0;width:5px;position:absolute;cursor:col-resize;user-select:none;height:100%";var g,m,y,f;p.onmousedown=e=>{m=u;g=e.pageX;y=m.offsetWidth;m.next&&(f=m.next.offsetWidth)};this.addEventListener("mousemove",(e=>{if(m){m.next&&m.next.setwidth(f-(e.pageX-g));m.setwidth(y+(e.pageX-g))}}));this.addEventListener("mouseup",(e=>g=f=y=void 0));u.groupby=t=>{if(u.values.includes(t)){e.grouped[a]=t;e.pager("groupby:"+a);d.innerHTML=`select[data-colname="${a}"]{background:var(--filterColor,#9cc)}`}else{d.innerHTML="";delete e.grouped[a];e.pager()}c.value=t};u.sorted=0;u.sort=(t=++u.sorted,r=1)=>{t>2&&(u.sorted=0);r&&e.THs.map((e=>u!=e&&(e.sorted=0)));s=1;e.pager()};n.onclick=e=>u.sort(++u.sorted,!e.ctrlKey)}));let s=this.getAttribute("rowindex")||1,r=(t,r=h("b","&nbsp;&nbsp;"+"de«‹›»"[t]+"&nbsp;&nbsp;"),i=(r.onclick=()=>e.pager(2==t?s=1:3==t?s-=o:4==t?s+=o:s=a-a%o+1)))=>r,n=h("td"),d=h("tr"),u=h("style"),b=h("span"),g=h("select",i.map((e=>`<option style=display:inline-block value=${e}>${e}</option>`)).join``);g.onchange=()=>e.pager(s,Number(g.value));n.id="pager";n.setAttribute("colspan","100%");d.append(n);n.append(b,r(2),r(3),g,r(4),r(5),u);e.thead.append(p);e.tfoot.append(d);e.table.append(e.thead,e.tbody,e.tfoot);e.table.setAttribute("role","table");e.table.style.tableLayout="fixed";e.pager=(t=s,r=o)=>{e.selected=e.TRs.filter((t=>Object.keys(e.grouped).map((s=>t.row[s]==e.grouped[s])).every((e=>e))));let i=Object.keys(e.grouped).length?e.selected.length:0;if("string"==typeof t&&t.includes("groupby")){t=1;e.selected.length}t=s=Number(t);r=Number(r);t<1&&(t=1);g.value=o=r;if(i-o<l){o=i||o;u.innerHTML="#pager b,#pager #pages{visibility:hidden}"}else{t>a&&(t=a-o);u.innerHTML=""+(t+o<a?1==t?"#pager b:nth-of-type(1),#pager b:nth-of-type(2){visibility:hidden}":"":"#pager b:nth-of-type(3),#pager b:nth-of-type(4){visibility:hidden}")}let n=e.THs.filter((e=>e.sorted)),d=(e,t)=>n.map((e=>e.isNumber?String(t.row[e.colname]).padStart(10,"0"):t.row[e.colname])).join``;n.map((t=>e.selected.sort(((e,s)=>t.isNumber?Number(d(0,2==t.sorted?s:e))-Number(d(0,2==t.sorted?e:s)):d(0,2==t.sorted?s:e).localeCompare(d(0,2==t.sorted?e:s))))));e.THs.map((e=>e.sorted?e.header.setAttribute("data-sort","▲▼"[e.sorted-1]):e.header.removeAttribute("data-sort")));e.selected=e.selected.slice(s-1,s+o-1);e.tbody.replaceChildren(...e.selected);b.innerHTML=`<span id=pages><button>1</button> [prevpages] ${t} ⎯ ${t+e.selected.length-1} [nextpages] /</span> ${a} `+(i?" ⭃ "+i:"");let c=e.THs.reduce(((e,t)=>{t.update(!0);let s=t.querySelector("optgroup")?.children.length||1;return e>s?e:s}),1);e.groupby.map((t=>t.size=e.grouped.size?c<11?c+4:11:1));this.savestate()}}return e}),{columns:new Map,groupby:[],grouped:{},TRs:[],selected:[],THs:[],TH:e=>"object"==typeof e?e:"number"==typeof e?this.$table.THs[e]:this.$table.THs.filter((t=>t.colname==e))[0],table:document.createElement("table"),thead:document.createElement("thead"),tbody:document.createElement("tbody"),tfoot:document.createElement("tfoot")});window.TM=this.$table;this.shadowRoot.append(this.$table.table);this.$table.TH("naam")?.sort();this.loadstate();this.$table.pager(1,30)}}savestate(){localStorage.setItem(btoa(this.for),JSON.stringify({sorted:this.$table.THs.map((e=>[e.colname,e.sorted])),grouped:this.$table.grouped}))}loadstate(e=JSON.parse(localStorage.getItem(btoa(this.for)))){if(e){Object.keys(e.grouped).map((t=>this.$table.TH(t).groupby(e.grouped[t])));e.sorted.map((([e,t])=>this.$table.TH(e).sorted=t))}}sort(e=this.getAttribute("sort"),t=this.$table.TH(e)){t&&t.sort()}});